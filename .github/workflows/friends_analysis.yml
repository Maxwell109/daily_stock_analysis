name: 每日股票分析-朋友版

on:
  # 定时触发 - 每天北京时间 18:45 (UTC 10:45)
  schedule:
    - cron: '45 10 * * 1-5'     # 周一到周五，UTC 10:45 = 北京时间 18:45
  
  # 手动触发
  workflow_dispatch:
    inputs:
      mode:
        description: '运行模式'
        required: true
        default: 'full'
        type: choice
        options:
          - full          # 完整分析（股票+大盘）
          - market-only   # 仅大盘复盘
          - stocks-only   # 仅股票分析

# 并发控制：同一时间只运行一个分析任务
concurrency:
  group: stock-analysis-friends
  cancel-in-progress: false

jobs:
  analyze:
    runs-on: ubuntu-latest
    # 添加超时限制，防止任务卡死
    timeout-minutes: 30
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
      
      - name: 设置 Python 环境
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: 安装依赖
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: 创建必要目录
        run: |
          mkdir -p data logs reports
      
      - name: 执行股票分析
        env:
          # ==========================================
          # AI 配置
          # ==========================================
          # Gemini AI（主选）
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GEMINI_MODEL: ${{ vars.GEMINI_MODEL || secrets.GEMINI_MODEL || 'gemini-2.5-flash' }}
          GEMINI_MODEL_FALLBACK: ${{ vars.GEMINI_MODEL_FALLBACK || secrets.GEMINI_MODEL_FALLBACK || 'gemini-2.5-flash' }}
          GEMINI_REQUEST_DELAY: '3.0'
          
          # OpenAI 兼容 API（备选）
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_BASE_URL: ${{ vars.OPENAI_BASE_URL || secrets.OPENAI_BASE_URL }}
          OPENAI_MODEL: ${{ vars.OPENAI_MODEL || secrets.OPENAI_MODEL }}
          
          # ==========================================
          # 数据源
          # ==========================================
          TUSHARE_TOKEN: ${{ secrets.TUSHARE_TOKEN }}
          
          # 
